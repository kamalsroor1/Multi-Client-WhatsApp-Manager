const express = require('express');
const multer = require('multer');
const whatsappService = require('./services/whatsappService');

const app = express();

// ุฅุนุฏุงุฏ multer ูุฑูุน ุงููููุงุช
const storage = multer.memoryStorage();
const upload = multer({
    storage: storage,
    limits: {
        fileSize: 10 * 1024 * 1024, // 10MB max
    },
    fileFilter: (req, file, cb) => {
        // ูุจูู ุงูุตูุฑ ููุท
        if (file.mimetype.startsWith('image/')) {
            cb(null, true);
        } else {
            cb(new Error('ููุณูุญ ุจุงูุตูุฑ ููุท'), false);
        }
    }
});

app.use(express.json());
app.use(express.static('public'));

// ุนุฑุถ QR ูุญุงูุฉ ุงูุงุชุตุงู ูุงูุฃุฑูุงู ูู ุตูุญุฉ ูุงุญุฏุฉ
app.get('/dashboard', async (req, res) => {
    const clientId = req.query.client_id;
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 20;
    const search = req.query.search || '';
    
    if (!clientId) return res.status(400).send("client_id is required");

    await whatsappService.initClient(clientId);
    const clientStatus = whatsappService.getClientStatus(clientId);
    
    let contactsHtml = '';
    let paginationHtml = '';
    
    if (clientStatus.ready) {
        try {
            const allContacts = await whatsappService.getContacts(clientId);
            
            // ููุชุฑุฉ ุฌูุงุช ุงูุงุชุตุงู ุญุณุจ ุงูุจุญุซ
            const filteredContacts = search ? 
                allContacts.filter(contact => 
                    contact.name.toLowerCase().includes(search.toLowerCase()) ||
                    contact.number.includes(search)
                ) : allContacts;
            
            const totalContacts = filteredContacts.length;
            const totalPages = Math.ceil(totalContacts / limit);
            const startIndex = (page - 1) * limit;
            const endIndex = startIndex + limit;
            const contacts = filteredContacts.slice(startIndex, endIndex);
            
            const tableRows = contacts.map((contact, index) => 
                `<tr>
                    <td>
                        <input type="checkbox" class="contact-checkbox" 
                               value="${contact.number}" 
                               data-name="${contact.name}"
                               onchange="dashboard.updateSelectedCount()">
                    </td>
                    <td>${startIndex + index + 1}</td>
                    <td>${contact.name}</td>
                    <td>${contact.number}</td>
                    <td><button onclick="dashboard.sendToNumber('${contact.number}')" class="btn-send">ุฅุฑุณุงู</button></td>
                </tr>`
            ).join('');
            
            // ุฅูุดุงุก Pagination
            let paginationButtons = '';
            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (page > 1) {
                paginationButtons += `<button onclick="dashboard.changePage(1)" class="btn-page">ุงูุฃููู</button>`;
                paginationButtons += `<button onclick="dashboard.changePage(${page - 1})" class="btn-page">ุงูุณุงุจูุฉ</button>`;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === page ? 'active' : '';
                paginationButtons += `<button onclick="dashboard.changePage(${i})" class="btn-page ${activeClass}">${i}</button>`;
            }
            
            if (page < totalPages) {
                paginationButtons += `<button onclick="dashboard.changePage(${page + 1})" class="btn-page">ุงูุชุงููุฉ</button>`;
                paginationButtons += `<button onclick="dashboard.changePage(${totalPages})" class="btn-page">ุงูุฃุฎูุฑุฉ</button>`;
            }
            
            paginationHtml = `
                <div class="pagination-container">
                    <div class="pagination-info">
                        ุนุฑุถ ${startIndex + 1} - ${Math.min(endIndex, totalContacts)} ูู ${totalContacts} ุฌูุฉ ุงุชุตุงู
                        ${search ? `| ุงูุจุญุซ ุนู: "${search}"` : ''}
                    </div>
                    <div class="pagination-controls">
                        <select onchange="dashboard.changeLimit(this.value)" class="limit-select">
                            <option value="10" ${limit === 10 ? 'selected' : ''}>10 ูู ุงูุตูุญุฉ</option>
                            <option value="20" ${limit === 20 ? 'selected' : ''}>20 ูู ุงูุตูุญุฉ</option>
                            <option value="50" ${limit === 50 ? 'selected' : ''}>50 ูู ุงูุตูุญุฉ</option>
                            <option value="100" ${limit === 100 ? 'selected' : ''}>100 ูู ุงูุตูุญุฉ</option>
                        </select>
                        <div class="pagination-buttons">${paginationButtons}</div>
                    </div>
                </div>
            `;
            
            contactsHtml = `
                <div class="search-section">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" 
                               placeholder="ุงูุจุญุซ ุจุงูุงุณู ุฃู ุงูุฑูู..." value="${search}">
                        <button onclick="dashboard.performSearch()" class="search-btn">๐ ุจุญุซ</button>
                        ${search ? `<button onclick="dashboard.clearSearch()" class="clear-search-btn">โ๏ธ ูุณุญ ุงูุจุญุซ</button>` : ''}
                    </div>
                    ${search && totalContacts === 0 ? 
                        `<div class="search-results">ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุงุฆุฌ ููุจุญุซ "${search}"</div>` : 
                        search ? `<div class="search-results">ุชู ุงูุนุซูุฑ ุนูู ${totalContacts} ูุชูุฌุฉ</div>` : ''
                    }
                </div>

                <div class="contacts-section">
                    <div class="contacts-header">
                        <h3>๐ ุฌูุงุช ุงูุงุชุตุงู (${allContacts.length})</h3>
                        <div class="selection-info">
                            <span id="selectedCount">0</span> ูุญุฏุฏ ูู ${contacts.length}
                            <button onclick="dashboard.selectAll()" class="btn-select-all">ุชุญุฏูุฏ ุงููู</button>
                            <button onclick="dashboard.deselectAll()" class="btn-deselect-all">ุฅูุบุงุก ุงูุชุญุฏูุฏ</button>
                            <button onclick="dashboard.clearSelectedNumbers()" class="btn-deselect-all">ูุณุญ ุฌููุน ุงููุญููุธุงุช</button>
                        </div>
                    </div>
                    
                    <div class="message-form">
                        <div class="message-input-section">
                            <textarea id="messageText" placeholder="ุงูุชุจ ุฑุณุงูุชู ููุง..." rows="3"></textarea>
                            
                            
                          
                        </div>

             
                                   <!-- Image Upload Section -->
                    <div class="image-upload-section" id="imageUploadSection">
                        <h3 style="margin-top: 0; color: #128c7e; text-align: center;">ุฅุฑูุงู ุตูุฑุฉ (ุงุฎุชูุงุฑู)</h3>
                        
                        <div class="image-upload-container">
                            <label for="imageInput" class="image-upload-label">
                                <div class="image-upload-icon">๐ท</div>
                                <div class="image-upload-text">ุงุถุบุท ููุง ูุงุฎุชูุงุฑ ุตูุฑุฉ ุฃู ุงุณุญุจ ุงูุตูุฑุฉ ููุง</div>
                                <div class="image-upload-hint">ูุฏุนู: JPG, PNG, GIF - ุญุฏ ุฃูุตู 10MB</div>
                            </label>
                            
                            <input type="file" id="imageInput" class="image-upload-input" accept="image/*" />
                            
                            <div class="image-preview-container" id="imagePreview">
                                <img id="" class="image-preview" alt="ูุนุงููุฉ ุงูุตูุฑุฉ" />
                                <div id="imageInfo" class="image-info"></div>
                                <button type="button" id="removeImageBtn" class="remove-image-btn">ุฅุฒุงูุฉ ุงูุตูุฑุฉ</button>
                            </div>
                            
                            <div id="imageError" class="image-upload-error" style="display: none;"></div>
                        </div>
                    </div>

                                            
                        <div class="send-options">
                            <button onclick="dashboard.sendToSelected()" class="btn-send-selected">ุฅุฑุณุงู ูููุญุฏุฏ</button>
                            <button onclick="dashboard.sendToAll()" class="btn-send-all">ุฅุฑุณุงู ูุฌููุน ุงููุญุฏุฏ</button>
                            <div class="delay-info">
                                <label>โฑ๏ธ ุชุฃุฎูุฑ ุนุดูุงุฆู: 5-10 ุซูุงูู</label>
                            </div>
                        </div>
                    </div>
                    
                    ${totalContacts > 0 ? paginationHtml : ''}
                    
                    ${totalContacts > 0 ? `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th width="5%">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="dashboard.toggleSelectAll()">
                                    </th>
                                    <th width="5%">#</th>
                                    <th width="40%">ุงูุงุณู</th>
                                    <th width="30%">ุงูุฑูู</th>
                                    <th width="20%">ุฅุฌุฑุงุก</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                    
                    ${paginationHtml}` : ''}
                </div>
            `;
        } catch (err) {
            contactsHtml = `<div class="error">ุฎุทุฃ ูู ุฌูุจ ุฌูุงุช ุงูุงุชุตุงู: ${err.message}</div>`;
        }
    }

    const html = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>WhatsApp Dashboard - ${clientId}</title>
            <link rel="stylesheet" href="dashboard.css">
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <div class="header-content">
                        <h1>๐ฑ WhatsApp Dashboard</h1>
                        <h2>Client ID: ${clientId}</h2>
                    </div>
                    <button onclick="logout()" class="logout-btn">๐ ุชุณุฌูู ุฎุฑูุฌ</button>
                </div>

                <div class="status-card">
                    ${getStatusContent(clientStatus)}
                </div>

                <div class="refresh-btn">
                    <button onclick="window.location.reload()" class="btn-refresh">๐ ุชุญุฏูุซ</button>
                </div>

                <div class="sending-progress" id="sendingProgress">
                    <div id="progressText">ุฌุงุฑู ุงูุฅุฑุณุงู...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="progressDetails"></div>
                </div>

                ${contactsHtml}
            </div>

            <script src="/dashboard.js"></script>
            <script>
                // ุชููุฆุฉ Dashboard Manager
                const dashboard = new DashboardManager('${clientId}', ${page}, ${limit});

                // Auto refresh every 5 seconds if not ready
                ${clientStatus.status !== 'authenticated' ? 'setTimeout(() => window.location.reload(), 5000);' : ''}

                // ุฏุงูุฉ ุชุณุฌูู ุงูุฎุฑูุฌ
                async function logout() {
                    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌุ')) return;
                    
                    try {
                        await fetch('/logout', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ client_id: '${clientId}' })
                        });
                        
                        dashboard.clearSelectedNumbers();
                        window.location.href = '/test';
                    } catch (error) {
                        alert('ุฎุทุฃ ูู ุชุณุฌูู ุงูุฎุฑูุฌ: ' + error.message);
                    }
                }
            </script>
        </body>
        </html>
    `;

    res.send(html);
});

function getStatusContent(clientStatus) {
    switch (clientStatus.status) {
        case 'initializing':
            return `
                <div class="loader"></div>
                <h3>โณ ุฌุงุฑู ุงูุชููุฆุฉ...</h3>
                <p>ูุฑุฌู ุงูุงูุชุธุงุฑุ ุฌุงุฑู ุชุญุถูุฑ ุงูุงุชุตุงู...</p>
            `;
        
        case 'qr_ready':
            return `
                <h3>๐ท ุงูุณุญ QR Code</h3>
                <p>ุงูุชุญ WhatsApp ุนูู ูุงุชูู ูุงุฐูุจ ุฅูู ุงูุฅุนุฏุงุฏุงุช > ุงูุฃุฌูุฒุฉ ุงููุฑุชุจุทุฉ > ุฑุจุท ุฌูุงุฒ</p>
                <div class="qr-container">
                    <img src="${clientStatus.qr}" alt="QR Code" />
                </div>
                <p><small>ููุชูู QR Code ุฎูุงู ุฏูููุชูู</small></p>
            `;
        
        case 'authenticated':
            return `
                <div class="success">
                    <h3>โ ูุชุตู ุจูุฌุงุญ!</h3>
                    <p>WhatsApp ุฌุงูุฒ ููุงุณุชุฎุฏุงู</p>
                </div>
            `;
        
        case 'error':
            return `
                <div class="error">
                    <h3>โ ุฎุทุฃ ูู ุงูุงุชุตุงู</h3>
                    <p>${clientStatus.error}</p>
                    <p>ุฌุงุฑู ุฅุนุงุฏุฉ ุงููุญุงููุฉ...</p>
                </div>
            `;
        
        default:
            return `
                <div class="loader"></div>
                <h3>๐ ุฌุงุฑู ุงูุจุฏุก...</h3>
            `;
    }
}

// API ูุฅุฑุณุงู ุฑุณุงูุฉ ูุน ุฃู ุจุฏูู ุตูุฑุฉ
app.post('/send-message', upload.single('image'), async (req, res) => {
    const { client_id, number, message } = req.body;
    const imageFile = req.file;
    
    try {
        let imageBuffer = null;
        let imageMimeType = null;
        
        if (imageFile) {
            imageBuffer = imageFile.buffer;
            imageMimeType = imageFile.mimetype;
        }
        
        await whatsappService.sendMessage(client_id, number, message, imageBuffer, imageMimeType);
        res.json({ success: true });
    } catch (err) {
        console.error('Send message error:', err);
        res.status(500).json({ success: false, error: err.message });
    }
});

// API ูุชุณุฌูู ุงูุฎุฑูุฌ
app.post('/logout', async (req, res) => {
    const { client_id } = req.body;
    try {
        await whatsappService.logout(client_id);
        res.json({ success: true });
    } catch (err) {
        res.status(500).json({ success: false, error: err.message });
    }
});

// ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
app.get('/test', (req, res) => {
    console.log('test');
    
    res.send(`
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>WhatsApp Multi-Client Dashboard</title>
            <link rel="stylesheet" href="dashboard.css">
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>๐ฑ WhatsApp Multi-Client Dashboard</h1>
                </div>
                
                <div class="status-card">
                    <h3>๐ ุงุจุฏุฃ ุฌูุณุฉ ุฌุฏูุฏุฉ</h3>
                    <p>ุฃุฏุฎู ูุนุฑู ุงูุนููู ููุจุฏุก:</p>
                    <div style="display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 20px;">
                        <input type="text" id="clientIdInput" placeholder="ูุซุงู: client1" 
                               style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
                        <button onclick="startClient()" class="btn-refresh">๐ ุงุจุฏุฃ</button>
                    </div>
                </div>
            </div>

            <script>
                function startClient() {
                    const clientId = document.getElementById('clientIdInput').value.trim();
                    if (!clientId) {
                        alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุนุฑู ุงูุนููู');
                        return;
                    }
                    window.location.href = '/dashboard?client_id=' + encodeURIComponent(clientId);
                }
                
                document.getElementById('clientIdInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        startClient();
                    }
                });
            </script>
        </body>
        </html>
    `);
});



// ... (rest of your existing Node.js code)

// API to get dashboard data (status, contacts, pagination info)
app.get('/api/dashboard-data', async (req, res) => { // Changed route to /api/dashboard-data
    const clientId = req.query.client_id;
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 20;
    const search = req.query.search || '';

    if (!clientId) {
        return res.status(400).json({ success: false, error: "client_id is required" });
    }

    try {
        await whatsappService.initClient(clientId);
        const clientStatus = whatsappService.getClientStatus(clientId);

        let contacts = [];
        let totalContacts = 0;
        let totalPages = 0;
        let startIndex = 0;
        let endIndex = 0;

        if (clientStatus.ready) {
            const allContacts = await whatsappService.getContacts(clientId);

            const filteredContacts = search ?
                allContacts.filter(contact =>
                    contact.name.toLowerCase().includes(search.toLowerCase()) ||
                    contact.number.includes(search)
                ) : allContacts;

            totalContacts = filteredContacts.length;
            totalPages = Math.ceil(totalContacts / limit);
            startIndex = (page - 1) * limit;
            endIndex = startIndex + limit;
            contacts = filteredContacts.slice(startIndex, endIndex);
        }

        res.json({
            success: true,
            clientId: clientId,
            clientStatus: clientStatus,
            contacts: contacts,
            pagination: {
                page: page,
                limit: limit,
                totalContacts: totalContacts,
                totalPages: totalPages,
                startIndex: startIndex,
                endIndex: endIndex,
                search: search
            }
        });

    } catch (err) {
        console.error('Error fetching dashboard data:', err);
        res.status(500).json({ success: false, error: err.message });
    }
});


// API ูุฅุฑุณุงู ุฑุณุงูุฉ ูุน ุฃู ุจุฏูู ุตูุฑุฉ
app.post('/api/send-message', upload.single('image'), async (req, res) => {
    const { client_id, number, message } = req.body;
    const imageFile = req.file;
    
    try {
        let imageBuffer = null;
        let imageMimeType = null;
        
        if (imageFile) {
            imageBuffer = imageFile.buffer;
            imageMimeType = imageFile.mimetype;
        }
        
        await whatsappService.sendMessage(client_id, number, message, imageBuffer, imageMimeType);
        res.json({ success: true });
    } catch (err) {
        console.error('Send message error:', err);
        res.status(500).json({ success: false, error: err.message });
    }
});

// API ูุชุณุฌูู ุงูุฎุฑูุฌ
app.post('/api/create-client', async (req, res) => {
    const clientId = req.body.client_id;

    if (!clientId) {
        return res.status(400).json({ success: false, error: 'Client ID is required.' });
    }

    if (clients[clientId]) {
        // If client already exists, return its current status/QR
        const clientData = clients[clientId];
        return res.json({
            success: true,
            status: clientData.status,
            message: `Client ${clientId} already exists. Current status: ${clientData.status}.`,
            qr: clientData.qr,
        });
    }

    const client = new Client({
        authStrategy: new LocalAuth({ clientId: clientId }), // Store session in a folder per client ID
        // puppeteer: { headless: true }, // Optional: run browser in headless mode
    });

    clients[clientId] = {
        client: client,
        status: 'initializing',
        message: 'ุฌุงุฑู ุชููุฆุฉ ุงููุงุชุณุงุจ...',
        qr: null,
    };

    client.on('qr', async (qr) => {
        const qrDataUrl = await qrcode.toDataURL(qr);
        clients[clientId].qr = qrDataUrl;
        clients[clientId].status = 'qr_ready';
        clients[clientId].message = 'ุงูุฑุฌุงุก ูุณุญ ุฑูุฒ QR ูู ุงููุงุชุณุงุจ.';
        console.log(`QR received for client ${clientId}`);
        // Optionally, emit via Socket.IO for real-time updates
        io.to(clientId).emit('qr', qrDataUrl);
        io.to(clientId).emit('status', clients[clientId].status);
    });

    client.on('ready', () => {
        clients[clientId].status = 'authenticated';
        clients[clientId].message = 'ุชู ุงูุงุชุตุงู ุจุงููุงุชุณุงุจ ุจูุฌุงุญ!';
        clients[clientId].qr = null; // Clear QR after authentication
        console.log(`Client ${clientId} is ready!`);
        // Optionally, emit via Socket.IO
        io.to(clientId).emit('status', clients[clientId].status);
        io.to(clientId).emit('message', clients[clientId].message);
        io.to(clientId).emit('qr', null); // Clear QR on client side
    });

    client.on('auth_failure', (msg) => {
        clients[clientId].status = 'error';
        clients[clientId].message = `ูุดู ุงููุตุงุฏูุฉ: ${msg}`;
        console.error(`Auth failure for client ${clientId}:`, msg);
        // Optionally, emit via Socket.IO
        io.to(clientId).emit('status', clients[clientId].status);
        io.to(clientId).emit('message', clients[clientId].message);
    });

    client.on('disconnected', (reason) => {
        clients[clientId].status = 'disconnected';
        clients[clientId].message = `ุชู ูุทุน ุงูุงุชุตุงู: ${reason}`;
        console.log(`Client ${clientId} disconnected:`, reason);
        // Optionally, emit via Socket.IO
        io.to(clientId).emit('status', clients[clientId].status);
        io.to(clientId).emit('message', clients[clientId].message);
        clients[clientId].qr = null; // Clear QR on disconnect
        client.destroy(); // Destroy the client instance
        delete clients[clientId]; // Remove from clients object
    });

    client.initialize()
        .then(() => {
            console.log(`Client ${clientId} initialized.`);
            res.json({
                success: true,
                status: clients[clientId].status,
                message: clients[clientId].message,
                qr: clients[clientId].qr, // May be null initially, updated on 'qr' event
                client_id: clientId
            });
        })
        .catch((err) => {
            console.error(`Error initializing client ${clientId}:`, err);
            clients[clientId].status = 'error';
            clients[clientId].message = `ุฎุทุฃ ูู ุงูุชููุฆุฉ: ${err.message}`;
            res.status(500).json({ success: false, error: `Initialization error: ${err.message}` });
        });
});

// Endpoint to get the current status of a specific client
app.get('/api/client-status', (req, res) => {
    const clientId = req.query.client_id;
    if (!clientId || !clients[clientId]) {
        return res.status(404).json({ success: false, error: 'Client not found or ID missing.' });
    }
    const clientData = clients[clientId];
    res.json({
        success: true,
        clientStatus: {
            status: clientData.status,
            message: clientData.message,
            qr: clientData.qr,
        },
    });
});

// Endpoint to log out a client
app.post('/api/logout', async (req, res) => {
    const clientId = req.body.client_id;
    if (!clientId || !clients[clientId]) {
        return res.status(404).json({ success: false, error: 'Client not found or ID missing.' });
    }

    try {
        await clients[clientId].client.logout(); // This also triggers 'disconnected' event
        delete clients[clientId];
        console.log(`Client ${clientId} logged out.`);
        res.json({ success: true, message: 'Client logged out successfully.' });
    } catch (error) {
        console.error(`Error logging out client ${clientId}:`, error);
        res.status(500).json({ success: false, error: error.message });
    }
});


// ูุนุงูุฌุฉ ุฃุฎุทุงุก multer
app.use((error, req, res, next) => {
    if (error instanceof multer.MulterError) {
        if (error.code === 'LIMIT_FILE_SIZE') {
            return res.status(400).json({ success: false, error: 'ุญุฌู ุงูููู ูุจูุฑ ุฌุฏุงู (ุงูุญุฏ ุงูุฃูุตู 10MB)' });
        }
    }
    if (error.message === 'ููุณูุญ ุจุงูุตูุฑ ููุท') {
        return res.status(400).json({ success: false, error: error.message });
    }
    next(error);
});

app.listen(4000, () => console.log('Server running on http://localhost:4000'));